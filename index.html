<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Lista SUS por intervalo</title>
<style>
body { font-family: Arial, sans-serif; padding: 16px; }
h2 { margin-bottom: 10px; }
label { display: block; margin-bottom: 6px; }
input[type=date] { padding: 4px; margin-right: 10px; }
button { padding: 5px 10px; font-size: 13px; margin-right: 6px; cursor: pointer; }

table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
th, td { border: 1px solid #ccc; padding: 6px; }
th { background: #f2f2f2; cursor: pointer; white-space: nowrap; }
tr.novo td { background: #d8ffd8; }

th.sortable::after {
  content: " ⇅";
  font-size: 10px;
  color: #666;
}
th.sorted-asc::after {
  content: " ↑";
}
th.sorted-desc::after {
  content: " ↓";
}

thead tr.filter-row th {
  background: #fafafa;
  cursor: default;
}
thead tr.filter-row input {
  width: 100%;
  box-sizing: border-box;
  font-size: 12px;
  padding: 2px 4px;
}

#historico { margin-top: 20px; font-size: 13px; background: #fafafa; padding: 10px; border: 1px solid #ddd; max-width: 480px; }
#armazenamento { margin-top: 16px; font-size: 13px; background: #fdfdfd; padding: 10px; border: 1px solid #ddd; max-width: 480px; }
#armaInfo { margin-top: 6px; white-space: pre-line; }
#armaAviso { margin-top: 6px; font-weight: bold; }
#armaAviso.ok { color: #166534; }
#armaAviso.alerta { color: #b45309; }
#armaAviso.critico { color: #b91c1c; }
</style>
</head>
<body>

<h2>Processador de lista SUS por intervalo</h2>

<label>
Arquivo CSV:
<input type="file" id="csvFile" accept=".csv,.txt">
</label>

<div>
Data inicial:
<input type="date" id="dataIni">
Data final:
<input type="date" id="dataFim">
<button id="aplicar">Aplicar intervalo</button>
</div>

<div style="margin-top:10px;">
<button id="copiarPeriodo" disabled>Copiar nomes do período</button>
<button id="copiarNovos" disabled>Copiar novos nomes</button>
</div>

<table>
<thead>
<tr class="header-row">
  <th class="sortable" data-col="cns">CNS</th>
  <th class="sortable" data-col="nome">Nome</th>
  <th class="sortable" data-col="idade">Idade</th>
  <th class="sortable" data-col="nasc">Nasc</th>
  <th class="sortable" data-col="prim">Primeiro agendamento</th>
  <th class="sortable" data-col="ult">Último agendamento</th>
  <th class="sortable" data-col="dias">Dias agendado</th>
  <th class="sortable" data-col="exames">Exames</th>
  <th class="sortable" data-col="novo">Novo</th>
</tr>
<tr class="filter-row">
  <th><input id="fCns" placeholder="filtrar"></th>
  <th><input id="fNome" placeholder="filtrar"></th>
  <th><input id="fIdade" placeholder="filtrar"></th>
  <th><input id="fNasc" placeholder="filtrar"></th>
  <th><input id="fPrim" placeholder="filtrar"></th>
  <th><input id="fUlt" placeholder="filtrar"></th>
  <th><input id="fDias" placeholder="filtrar"></th>
  <th><input id="fExames" placeholder="filtrar"></th>
  <th><input id="fNovo" placeholder="sim/não"></th>
</tr>
</thead>
<tbody id="tb"></tbody>
</table>

<div id="historico">
<b>Histórico de intervalos:</b>
<div id="hist"></div>
</div>

<div id="armazenamento">
<b>Armazenamento local (localStorage):</b>
<div id="armaInfo"></div>
<div id="armaAviso"></div>
<div style="margin-top:6px;">
  <button id="btAtualizarArma">Atualizar info</button>
  <button id="btLimparHistorico">Limpar histórico gravado</button>
</div>
<small>
Chaves usadas:<br>
<b>historicoChaves</b> = pares CNS + data de agendamento já vistos<br>
<b>historicoIntervalos</b> = intervalos que você aplicou na tela
</small>
</div>

<script>
let registros = [];
let historicoChaves = JSON.parse(localStorage.getItem("historicoChaves")||"{}");
let historicoIntervalos = JSON.parse(localStorage.getItem("historicoIntervalos")||"[]");

// linhas agregadas por CNS no intervalo atual
let linhasBase = [];
let currentSort = { col: "cns", dir: "asc" };

function toSortDate(s){
  if(!s) return "";
  let p = s.replace(/\/|-/g,".").split(".");
  if(p.length!=3) return "";
  let [d,m,y]=p;
  d=d.padStart(2,"0");
  m=m.padStart(2,"0");
  if(y.length==2) y="20"+y;
  return y+"-"+m+"-"+d;
}

function toHuman(s){
  if(!s) return "";
  let p=s.split("-");
  return p[2]+"/"+p[1]+"/"+p[0];
}

function toTitle(s){
  return s.toLowerCase().split(" ").map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(" ");
}

document.getElementById("csvFile").addEventListener("change", e=>{
  let f=e.target.files[0];
  if(!f) return;
  let r=new FileReader();
  r.onload=x=>{
    let lines=x.target.result.split(/\r?\n/);
    registros=[];
    for(let ln of lines){
      let c=ln.split(";");
      if(c.length<13) continue;
      let cns=c[9].trim();
      let nome=c[10].trim();
      let nasc=c[11].trim();
      let idade=c[12].trim();
      let ag=c[6].trim();

      if(!/^\d{15}$/.test(cns)) continue;
      if(!nome) continue;

      registros.push({
        cns,
        nome: toTitle(nome),
        nasc,
        idade: idade?parseInt(idade):null,
        agRaw: ag,
        agSort: toSortDate(ag),
        chave: cns+"|"+toSortDate(ag)
      });
    }
    alert("Arquivo carregado com "+registros.length+" exames");
  };
  r.readAsText(f,"ISO-8859-1");
});

document.getElementById("aplicar").addEventListener("click",()=>{
  let ini=document.getElementById("dataIni").value;
  let fim=document.getElementById("dataFim").value;
  if(!ini || !fim){
    alert("Escolha data inicial e final");
    return;
  }

  let tb=document.getElementById("tb");
  tb.innerHTML="";
  linhasBase = [];

  let fIni=ini;
  let fFim=fim;

  let filtrado=registros.filter(r=>r.agSort>=fIni && r.agSort<=fFim);

  let mapa = {};
  for(let r of filtrado){
    if(!mapa[r.cns]){
      mapa[r.cns]={
        cns:r.cns,
        nome:r.nome,
        nasc:r.nasc,
        idade:r.idade,
        min:r.agSort,
        max:r.agSort,
        exames:1,
        dias:new Set([r.agSort]),
        novo:false
      };
    }else{
      let o=mapa[r.cns];
      o.exames++;
      if(r.agSort<o.min) o.min=r.agSort;
      if(r.agSort>o.max) o.max=r.agSort;
      o.dias.add(r.agSort);
    }
  }

  let novosNoPeriodo = new Set();
  for(let r of filtrado){
    if(!historicoChaves[r.chave]){
      if(mapa[r.cns]) {
        mapa[r.cns].novo=true;
        novosNoPeriodo.add(r.cns);
      }
    }
  }

  linhasBase = Object.values(mapa).map(o => ({
    cns: o.cns,
    nome: o.nome,
    nasc: o.nasc,
    idade: o.idade,
    min: o.min,
    max: o.max,
    dias: o.dias.size,
    exames: o.exames,
    novo: o.novo
  }));

  for(let r of filtrado){
    historicoChaves[r.chave]=true;
  }
  localStorage.setItem("historicoChaves",JSON.stringify(historicoChaves));

  historicoIntervalos.push({
    ini:ini,
    fim:fim,
    cns:Object.keys(mapa).length,
    novos:novosNoPeriodo.size,
    exames:filtrado.length
  });
  localStorage.setItem("historicoIntervalos",JSON.stringify(historicoIntervalos));
  renderHistorico();
  renderArmazenamento();

  document.getElementById("copiarPeriodo").disabled=false;
  document.getElementById("copiarNovos").disabled=false;

  currentSort = { col: "cns", dir: "asc" };
  renderTabela();
});

function renderTabela(){
  let tb=document.getElementById("tb");
  tb.innerHTML="";

  document.querySelectorAll(".header-row th").forEach(th=>{
    th.classList.remove("sorted-asc","sorted-desc");
  });
  let ativo=document.querySelector('.header-row th[data-col="'+currentSort.col+'"]');
  if(ativo){
    ativo.classList.add(currentSort.dir==="asc"?"sorted-asc":"sorted-desc");
  }

  let fCns=document.getElementById("fCns").value.toLowerCase().trim();
  let fNome=document.getElementById("fNome").value.toLowerCase().trim();
  let fIdade=document.getElementById("fIdade").value.toLowerCase().trim();
  let fNasc=document.getElementById("fNasc").value.toLowerCase().trim();
  let fPrim=document.getElementById("fPrim").value.toLowerCase().trim();
  let fUlt=document.getElementById("fUlt").value.toLowerCase().trim();
  let fDias=document.getElementById("fDias").value.toLowerCase().trim();
  let fExames=document.getElementById("fExames").value.toLowerCase().trim();
  let fNovo=document.getElementById("fNovo").value.toLowerCase().trim();

  let filtradas = linhasBase.filter(o=>{
    if(fCns && !o.cns.toLowerCase().includes(fCns)) return false;
    let nomeExib = o.nome;
    if(o.idade>=60) nomeExib = nomeExib + "*";
    if(fNome && !nomeExib.toLowerCase().includes(fNome)) return false;
    if(fIdade && (o.idade===null || !String(o.idade).includes(fIdade))) return false;
    if(fNasc && !(o.nasc||"").toLowerCase().includes(fNasc)) return false;
    if(fPrim && !toHuman(o.min).toLowerCase().includes(fPrim)) return false;
    if(fUlt && !toHuman(o.max).toLowerCase().includes(fUlt)) return false;
    if(fDias && !String(o.dias).includes(fDias)) return false;
    if(fExames && !String(o.exames).includes(fExames)) return false;
    if(fNovo){
      let alvo = fNovo.startsWith("s") ? "sim" : fNovo;
      let ehNovo = o.novo ? "sim" : "nao";
      if(!ehNovo.includes(alvo)) return false;
    }
    return true;
  });

  let dir = currentSort.dir==="asc"?1:-1;
  filtradas.sort((a,b)=>{
    let va, vb;
    switch(currentSort.col){
      case "cns": va=a.cns; vb=b.cns; break;
      case "nome": va=a.nome.toLowerCase(); vb=b.nome.toLowerCase(); break;
      case "idade": va=a.idade===null?-9999:a.idade; vb=b.idade===null?-9999:b.idade; break;
      case "nasc": va=(a.nasc||""); vb=(b.nasc||""); break;
      case "prim": va=a.min||""; vb=b.min||""; break;
      case "ult": va=a.max||""; vb=b.max||""; break;
      case "dias": va=a.dias; vb=b.dias; break;
      case "exames": va=a.exames; vb=b.exames; break;
      case "novo": va=a.novo?1:0; vb=b.novo?1:0; break;
      default: va=""; vb="";
    }
    if(va<vb) return -1*dir;
    if(va>vb) return 1*dir;
    return 0;
  });

  for(let o of filtradas){
    let tr=document.createElement("tr");
    if(o.novo) tr.classList.add("novo");

    let nomeExib = o.nome;
    if(o.idade>=60) nomeExib = nomeExib + "*";

    tr.innerHTML =
      "<td>"+o.cns+"</td>"+
      "<td>"+nomeExib+"</td>"+
      "<td>"+(o.idade||"")+"</td>"+
      "<td>"+(o.nasc||"")+"</td>"+
      "<td>"+toHuman(o.min)+"</td>"+
      "<td>"+toHuman(o.max)+"</td>"+
      "<td>"+o.dias+"</td>"+
      "<td>"+o.exames+"</td>"+
      "<td>"+(o.novo?"Sim":"")+"</td>";

    tb.appendChild(tr);
  }
}

function renderHistorico(){
  let h=document.getElementById("hist");
  h.innerHTML="";
  for(let i of historicoIntervalos){
    let d=document.createElement("div");
    d.textContent = i.ini+" a "+i.fim+" -> "+i.cns+" cns, "+i.exames+" exames, "+i.novos+" novos";
    h.appendChild(d);
  }
}

function calcLocalStorageUso(){
  let totalBytes = 0;
  let detalhes = [];

  for(let i=0;i<localStorage.length;i++){
    let k = localStorage.key(i);
    let v = localStorage.getItem(k) || "";
    let bytes = (k.length + v.length) * 2;
    totalBytes += bytes;

    if(k === "historicoChaves"){
      let obj;
      try{ obj = JSON.parse(v||"{}"); }catch(e){ obj = {}; }
      let qtd = Object.keys(obj).length;
      detalhes.push("historicoChaves: "+qtd+" chaves, ~"+Math.round(bytes/1024)+" KB");
    }else if(k === "historicoIntervalos"){
      let arr;
      try{ arr = JSON.parse(v||"[]"); }catch(e){ arr = []; }
      detalhes.push("historicoIntervalos: "+arr.length+" intervalos, ~"+Math.round(bytes/1024)+" KB");
    }else{
      detalhes.push(k+": ~"+Math.round(bytes/1024)+" KB");
    }
  }

  let totalKB = totalBytes/1024;
  let totalMB = totalKB/1024;

  return {
    detalhes,
    totalKB: totalKB,
    totalMB: totalMB
  };
}

function renderArmazenamento(){
  let infoEl = document.getElementById("armaInfo");
  let avisoEl = document.getElementById("armaAviso");
  avisoEl.className = "";
  let uso = calcLocalStorageUso();

  if(uso.detalhes.length === 0){
    infoEl.textContent = "Nenhum dado salvo no localStorage ainda.";
  }else{
    infoEl.textContent = uso.detalhes.join("\n") +
      "\nTotal aproximado: "+uso.totalMB.toFixed(2)+" MB";
  }

  let alertaMB = 4;
  let criticoMB = 4.5;

  if(uso.totalMB === 0){
    avisoEl.textContent = "Armazenamento vazio.";
    avisoEl.classList.add("ok");
  }else if(uso.totalMB < alertaMB){
    avisoEl.textContent = "Espaço confortável. Sem risco imediato.";
    avisoEl.classList.add("ok");
  }else if(uso.totalMB < criticoMB){
    avisoEl.textContent = "Atenção: uso de armazenamento está alto. Considere limpar o histórico em breve.";
    avisoEl.classList.add("alerta");
  }else{
    avisoEl.textContent = "Quase no limite estimado do navegador. Sugestão: limpar histórico para evitar erro de espaço.";
    avisoEl.classList.add("critico");
  }
}

renderHistorico();
renderArmazenamento();

document.getElementById("copiarPeriodo").addEventListener("click",()=>{
  let linhas=[...document.querySelectorAll("#tb tr")];
  let txt="";
  for(let tr of linhas){
    txt+=tr.children[1].innerText+"\n";
  }
  navigator.clipboard.writeText(txt);
  alert("Copiado");
});

document.getElementById("copiarNovos").addEventListener("click",()=>{
  let linhas=[...document.querySelectorAll("#tb tr.novo")];
  let txt="";
  for(let tr of linhas){
    txt+=tr.children[1].innerText+"\n";
  }
  navigator.clipboard.writeText(txt);
  alert("Novos copiados");
});

document.getElementById("btAtualizarArma").addEventListener("click",()=>{
  renderArmazenamento();
  alert("Informações de armazenamento atualizadas.");
});

document.getElementById("btLimparHistorico").addEventListener("click",()=>{
  if(!confirm("Tem certeza que deseja limpar o histórico gravado (chaves e intervalos)?")) return;
  historicoChaves = {};
  historicoIntervalos = [];
  localStorage.removeItem("historicoChaves");
  localStorage.removeItem("historicoIntervalos");
  document.getElementById("tb").innerHTML="";
  document.getElementById("copiarPeriodo").disabled=true;
  document.getElementById("copiarNovos").disabled=true;
  renderHistorico();
  renderArmazenamento();
  alert("Histórico e chaves limpos.");
});

// filtros
["fCns","fNome","fIdade","fNasc","fPrim","fUlt","fDias","fExames","fNovo"].forEach(id=>{
  document.getElementById(id).addEventListener("input",()=>{
    renderTabela();
  });
});

// clique para ordenar
document.querySelectorAll(".header-row th.sortable").forEach(th=>{
  th.addEventListener("click",()=>{
    let col=th.getAttribute("data-col");
    if(currentSort.col===col){
      currentSort.dir = currentSort.dir==="asc"?"desc":"asc";
    }else{
      currentSort.col=col;
      currentSort.dir="asc";
    }
    renderTabela();
  });
});
</script>

</body>
</html>
